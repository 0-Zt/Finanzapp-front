<article class="glass-card animate-fade-up h-full flex flex-col">
  <header class="flex flex-wrap items-start justify-between gap-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Presupuestos</h2>
      <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">
        Control de gastos del mes
      </p>
      @if (summary?.month) {
        <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
          Mes: {{ summary?.month }}
        </p>
      }
    </div>
    <a
      routerLink="/profile"
      class="filter-chip hover:bg-slate-100 dark:hover:bg-slate-700"
    >
      Ver todos
    </a>
  </header>

  @if (!summary || summary.budgets.length === 0) {
    <div class="mt-6 text-sm text-slate-500 dark:text-slate-300">
      <p>No hay presupuestos configurados.</p>
      <a
        routerLink="/profile"
        class="mt-2 inline-block text-brand-600 hover:text-brand-700 dark:text-brand-400 dark:hover:text-brand-300"
      >
        Configurar presupuestos
      </a>
    </div>
  } @else {
    <div class="mt-6 space-y-4 flex-1">
      <!-- Overall Progress -->
      <div class="rounded-xl border border-slate-200/70 bg-white/50 p-4 dark:border-slate-700/50 dark:bg-slate-800/50">
        <div class="flex items-center justify-between">
          <span class="text-sm font-medium text-slate-600 dark:text-slate-300">Total gastado</span>
          <span class="text-lg font-semibold text-slate-900 dark:text-white">
            {{ formatCurrency(summary.total_spent) }}
          </span>
        </div>
        <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">
          de {{ formatCurrency(summary.total_budget) }} presupuestado
        </div>
        @if (summary.unbudgeted_total > 0) {
          <div class="mt-1 text-xs text-amber-600 dark:text-amber-300">
            Sin presupuesto: {{ formatCurrency(summary.unbudgeted_total) }}
          </div>
        }
        <div class="mt-3">
          <div class="h-2 w-full overflow-hidden rounded-full bg-slate-200 dark:bg-slate-700">
            <div
              class="h-full rounded-full transition-all duration-500"
              [ngClass]="statusClasses"
              [style.width]="progressWidth"
            ></div>
          </div>
          <div class="mt-1.5 text-right text-xs text-slate-500 dark:text-slate-400">
            {{ totalPercentage }}%
          </div>
        </div>
      </div>

      <!-- Alerts -->
      @if (currentAlert; as alert) {
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium text-slate-700 dark:text-slate-300">Alertas</h3>
            @if (hasAlertNavigation) {
              <div class="flex items-center gap-2">
                <button
                  type="button"
                  class="flex h-7 w-7 items-center justify-center rounded-full border border-slate-200 text-slate-500 transition-colors hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800"
                  (click)="previousAlert()"
                  aria-label="Anterior"
                >
                  <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 18l-6-6 6-6" />
                  </svg>
                </button>
                <button
                  type="button"
                  class="flex h-7 w-7 items-center justify-center rounded-full border border-slate-200 text-slate-500 transition-colors hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800"
                  (click)="nextAlert()"
                  aria-label="Siguiente"
                >
                  <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 6l6 6-6 6" />
                  </svg>
                </button>
              </div>
            }
          </div>

          <div
            class="flex items-center gap-3 rounded-xl border px-3 py-2"
            [ngClass]="alertContainerClasses(alert.kind)"
          >
            <div
              class="flex h-8 w-8 items-center justify-center rounded-lg"
              [style.backgroundColor]="alert.budget.category_color + '20'"
            >
              <app-category-icon
                [icon]="alert.budget.category_icon"
                [size]="16"
                [ariaLabel]="alert.budget.category_name"
                [style.color]="alert.budget.category_color"
              ></app-category-icon>
            </div>
            <div class="flex-1 min-w-0">
              <p class="truncate text-sm font-medium text-slate-900 dark:text-white">
                {{ alert.budget.category_name }}
              </p>
              @if (alert.kind === 'exceeded') {
                <p class="text-xs" [ngClass]="alertIconClasses(alert.kind)">
                  Excedido por {{ formatCurrency(alert.budget.spent_amount - alert.budget.effective_budget_amount) }}
                </p>
              } @else {
                <p class="text-xs" [ngClass]="alertIconClasses(alert.kind)">
                  {{ alert.budget.percentage.toFixed(0) }}% del presupuesto usado
                </p>
              }
            </div>
            <span
              class="rounded-full px-2 py-1 text-[11px] font-semibold"
              [ngClass]="alertIconClasses(alert.kind)"
            >
              {{ alert.kind === 'exceeded' ? 'Excedido' : 'Alerta' }}
            </span>
          </div>

          <div class="flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500 dark:text-slate-300">
            <span>{{ alertIndex + 1 }} / {{ alertCount }}</span>
            <span>Excedidos: {{ overBudgetBudgets.length }} | Alertas: {{ warningBudgets.length }}</span>
          </div>
        </div>
      } @else {
        <div class="flex items-center gap-3 rounded-xl border border-emerald-200/70 bg-emerald-50/50 px-4 py-3 dark:border-emerald-800/50 dark:bg-emerald-900/20">
          <svg
            class="h-6 w-6 text-emerald-600 dark:text-emerald-400"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="9"></circle>
            <path d="m9 12.75 2.25 2.25L15 9.75"></path>
          </svg>
          <p class="text-sm text-emerald-700 dark:text-emerald-300">
            Todos los presupuestos estan bajo control
          </p>
        </div>
      }
    </div>
  }
</article>
