<section class="page-shell">
  <!-- Header -->
  <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl sm:text-3xl font-semibold text-slate-900 dark:text-white">Transacciones</h1>
      <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">
        Consulta y analiza todos tus movimientos financieros.
      </p>
    </div>
    <button type="button" class="primary-button" (click)="onAddTransaction()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      Nueva transacción
    </button>
  </header>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="flex items-center justify-center py-12">
      <div class="flex items-center gap-3 text-slate-500 dark:text-slate-400">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-sm font-medium">Cargando transacciones...</span>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (errorMessage) {
    <div class="rounded-2xl border border-rose-200/70 bg-rose-50/80 px-5 py-4 text-sm text-rose-700 shadow-sm dark:border-rose-500/20 dark:bg-rose-500/10 dark:text-rose-200">
      {{ errorMessage }}
    </div>
  }

  @if (!isLoading && !errorMessage) {
    <!-- Summary Stats -->
    <div class="summary-stats animate-fade-up">
      <div class="stat-card">
        <span class="stat-card-label">Ingresos</span>
        <span class="stat-card-value income">+{{ formatCurrency(summary.totalIncome) }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-card-label">Gastos</span>
        <span class="stat-card-value expense">-{{ formatCurrency(summary.totalExpense) }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-card-label">Balance</span>
        <span class="stat-card-value" [class.income]="summary.balance >= 0" [class.expense]="summary.balance < 0">
          {{ summary.balance >= 0 ? '+' : '-' }}{{ formatCurrency(summary.balance) }}
        </span>
      </div>
      <div class="stat-card">
        <span class="stat-card-label">Movimientos</span>
        <span class="stat-card-value">{{ summary.transactionCount }}</span>
      </div>
    </div>

    <!-- Filters -->
    <div class="glass-card !p-4 animate-fade-up" style="animation-delay: 60ms">
      <div class="filters-compact">
        <!-- Search -->
        <div class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
               class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
          </svg>
          <input
            type="search"
            class="input-field !pl-10 !py-2.5"
            placeholder="Buscar transacción..."
            [ngModel]="transactionFilters.search"
            (ngModelChange)="onSearchChange($event)"
          />
        </div>

        <!-- Filter Chips (horizontal scroll on mobile) -->
        <div class="filters-row">
          <select
            class="filter-select"
            [ngModel]="transactionFilters.categoryId"
            (ngModelChange)="onCategoryChange($event)"
          >
            <option [ngValue]="'all'">Categoría</option>
            @for (category of categories; track category.id) {
              <option [ngValue]="category.id">{{ category.name }}</option>
            }
          </select>

          <select
            class="filter-select"
            [ngModel]="transactionFilters.type"
            (ngModelChange)="onTypeChange($event)"
          >
            <option [ngValue]="'all'">Tipo</option>
            <option [ngValue]="'expense'">Gastos</option>
            <option [ngValue]="'income'">Ingresos</option>
          </select>

          <select
            class="filter-select"
            [ngModel]="transactionFilters.month"
            (ngModelChange)="onMonthChange($event)"
          >
            <option [ngValue]="'all'">Mes</option>
            @for (month of monthOptions; track month.value) {
              <option [ngValue]="month.value">{{ month.label }}</option>
            }
          </select>

          <select
            class="filter-select"
            [ngModel]="transactionFilters.status"
            (ngModelChange)="onStatusChange($event)"
          >
            <option [ngValue]="'all'">Estado</option>
            <option [ngValue]="'completed'">Completado</option>
            <option [ngValue]="'pending'">Pendiente</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Transaction List -->
    <div class="animate-fade-up" style="animation-delay: 120ms">
      <app-transaction-list-grouped
        [groups]="transactionGroups"
        [pagination]="pagination"
        [isLoading]="isLoading"
        (editTransaction)="onEditTransaction($event)"
        (deleteTransaction)="onDeleteTransaction($event)"
        (pageChange)="onPageChange($event)"
      ></app-transaction-list-grouped>
    </div>
  }

  <!-- Transaction Form Modal -->
  <app-transaction-form
    [categories]="categories"
    [isOpen]="isFormOpen"
    [mode]="formMode"
    [transaction]="editingTransaction"
    (createTransaction)="onCreateTransaction($event)"
    (updateTransaction)="onUpdateTransaction($event)"
    (close)="onCloseTransactionForm()"
  ></app-transaction-form>
</section>
